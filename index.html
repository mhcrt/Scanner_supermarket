<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Escáner PWA</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* Estilos básicos para que se vea bien en el móvil */
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f0f2f5; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 12px; shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        select, input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #007bff; color: white; font-weight: bold; border: none; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
    </style>
</head>
<body>

    <div id="pantalla-inicio" class="card">
        <h2>Registro de Entrada</h2>
        <label>¿Dónde estás?</label>
        <select id="lista-locales"></select>
        <input type="text" id="nuevo-local" placeholder="Nombre de nuevo local">
        <button onclick="comenzar()">Confirmar e Ir al Escáner</button>
    </div>

    <div id="pantalla-escaner" class="hidden">
        <h3 id="info-establecimiento"></h3>
        <div id="reader"></div> 
        <button onclick="volver()" style="background:#6c757d;">Cerrar Escáner</button>
    </div>

    <script>
        // --- VARIABLES DE MEMORIA (BASE DE DATOS LOCAL) ---
        let locales = JSON.parse(localStorage.getItem('misLocales')) || ["Almacén Central", "Tienda Norte"];
        let productosConocidos = JSON.parse(localStorage.getItem('productos')) || {};
        let html5QrCode = null;

        // Al abrir la app, llenamos la lista de locales
        const selectLocales = document.getElementById('lista-locales');
        function actualizarSelect() {
            selectLocales.innerHTML = '<option value="">-- Seleccionar --</option>';
            locales.forEach(l => {
                let opt = document.createElement('option');
                opt.value = l; opt.textContent = l;
                selectLocales.appendChild(opt);
            });
        }
        actualizarSelect();

        // --- LÓGICA DE INICIO ---
        function comenzar() {
            const inputNuevo = document.getElementById('nuevo-local').value;
            const seleccionado = selectLocales.value;
            let localFinal = inputNuevo || seleccionado;

            if (!localFinal) return alert("Por favor indica un local");

            // Si es nuevo, lo guardamos en la lista
            if (inputNuevo && !locales.includes(inputNuevo)) {
                locales.push(inputNuevo);
                localStorage.setItem('misLocales', JSON.stringify(locales));
            }

            document.getElementById('info-establecimiento').textContent = "Local: " + localFinal;
            document.getElementById('pantalla-inicio').classList.add('hidden');
            document.getElementById('pantalla-escaner').classList.remove('hidden');
            
            encenderCamara();
        }

        // --- LÓGICA DE LA CÁMARA ---
        function encenderCamara() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 150 } };

            html5QrCode.start(
                { facingMode: "environment" }, // FORZAR CÁMARA TRASERA
                config,
                onScanSuccess
            );
        }

        // --- LÓGICA DE DETECCIÓN (LO QUE PREGUNTABAS) ---
        function onScanSuccess(decodedText) {
            html5QrCode.pause(); // Pausa para procesar

            let nombre = productosConocidos[decodedText];

            if (!nombre) {
                // Si el código NO existe, pedimos el nombre (ACTUALIZAR)
                nombre = prompt("Código nuevo detectado: " + decodedText + "\n¿Cómo se llama este producto?");
                if (nombre) {
                    productosConocidos[decodedText] = nombre;
                    localStorage.setItem('productos', JSON.stringify(productosConocidos));
                    alert("Producto guardado: " + nombre);
                }
            } else {
                // Si YA existe, solo avisamos
                alert("Detectado: " + nombre);
            }

            // Registrar el escaneo en consola (o historial)
            console.log("Escaneado " + nombre + " en " + selectLocales.value);

            // Reanudar cámara tras 2 segundos
            setTimeout(() => html5QrCode.resume(), 2000);
        }

        function volver() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('pantalla-inicio').classList.remove('hidden');
                    document.getElementById('pantalla-escaner').classList.add('hidden');
                });
            }
        }
    </script>
</body>
</html>
